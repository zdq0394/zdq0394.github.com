# Redis主从同步
## 使用方法
Redis是支持**主从同步**的，而且也支持**一主多从以及多级从结构**。

主从结构，一是为了纯粹的冗余备份，二是为了提升读性能，比如很消耗性能的SORT就可以由从服务器来承担。

redis的主从同步是**异步进行**的，这意味着主从同步**不会影响主逻辑**，也不会降低redis的处理性能。

主从架构中，可以考虑**关闭主服务器的数据持久化功能**，只让从服务器进行持久化，这样可以提高主服务器的处理性能。

在主从架构中，**从服务器通常被设置为只读模式**，这样可以避免从服务器的数据被误修改。
但是从服务器仍然可以接受CONFIG等指令，所以还是不应该将从服务器直接暴露到不安全的网络环境中。
如果必须如此，那可以考虑给重要指令进行重命名，来避免命令被外人误执行。

##　同步原理
从服务器会向主服务器发出SYNC指令，当主服务器接到此命令后，就会调用BGSAVE指令来创建一个子进程专门进行数据持久化工作，也就是将主服务器的数据写入RDB文件中。
在数据持久化期间，主服务器将执行的写指令都缓存在内存中。
在BGSAVE指令执行完成后，主服务器会将持久化好的RDB文件发送给从服务器，从服务器接到此文件后会将其存储到磁盘上，然后再将其读取到内存中。
这个动作完成后，主服务器会将这段时间缓存的写指令再以redis协议的格式发送给从服务器。

另外，即使有多个从服务器同时发来SYNC指令，主服务器也只会执行一次BGSAVE，然后把持久化好的RDB文件发给多个下游。
* Redis2.8版本之前，如果从服务器与主服务器因某些原因断开连接的话，都会进行一次主从之间的全量的数据同步；
* Redis2.8版本之后，Redis支持了效率更高的增量同步策略，这大大降低了连接断开的恢复成本。

主服务器会在内存中维护一个缓冲区，缓冲区中存储着将要发给从服务器的内容。
从服务器在与主服务器出现网络瞬断之后，从服务器会尝试再次与主服务器连接，一旦连接成功，从服务器就会把**希望同步的主服务器ID**和**希望请求的数据的偏移位置（replication offset）**发送出去。
主服务器接收到这样的同步请求后，首先会验证主服务器ID是否和自己的ID匹配，其次会检查**请求的偏移位置**是否存在于自己的缓冲区中，如果两者都满足的话，主服务器就会向从服务器发送增量内容。

增量同步功能，需要服务器端支持全新的**PSYNC**指令。这个指令，只有在redis 2.8之后才具有。